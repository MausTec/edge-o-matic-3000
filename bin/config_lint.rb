#!/usr/bin/env ruby
#
# Config is pretty spread out right now, so this lints it up.

DIR = File.expand_path(File.join(File.dirname(__FILE__), ".."))
puts "IN: #{DIR}"

require 'optimist'

opts = Optimist::options do
  banner <<-TEXT
Validate that the Config struct is in sync with documentation and various getters/setters.
TEXT

  opt :fix, "Automatically try and fix stuff", default: false
end

# Parse in Config
config_h = File.join(DIR, "include", "config.h")
in_struct = false

$config_values = []

$errors = []
def error(file, line, message, fixed)
  $errors.push({ fixed: false, file: file, line: (line || -1) + 1, message: message })
end

#== Check Readme
readme_md = File.join(DIR, "README.md")
readme_md_out = []
in_configuration = false

File.foreach(readme_md).with_index do |line, i|
  if line =~ /^## Configuration$/
    in_configuration = true;
  elsif line =~ /^#/
    in_configuration = false;
  end

  if opts[:fix]
    readme_md_out << line
  end

  next unless in_configuration
  match = line =~ /\|(`?\w+`?)\|(.*?)\|(.*?)\|(.*?)\|/
  next unless match
  config = { key: $1, type: $2, default: $3, note: $4 }
  next if $1 == "---" or $1 == "Key"
  $config_values << config;

  unless config[:key] =~ /^`\w+`$/
    error readme_md, i, "Missing backticks around value name: `#{config[:key]}`", true
    if opts[:fix]
      readme_md_out.pop
      readme_md_out << "|`#{config[:key]}`|#{config[:type]}|#{config[:default]}|#{config[:note]}|"
    end
  end

  config[:key].gsub!('`', '');
  puts config
end



###

help_file = <<-CC
// clang-format off

/**
 * THIS FILE IS AUTOMATICALLY GENERATED. DO NOT MANUALLY EDIT THIS FILE.
 *
 * Run config_lint.rb --fix to update this file.
 */

#ifndef __assets__config_help_h
#define __assets__config_help_h

#ifdef __cplusplus
extern "C" {
#endif

#define INCLUDE_HELP 1

#ifdef INCLUDE_HELP
#define _HELPSTR(str) str
#else
#define _HELPSTR(str) NULL
#endif

CC

$config_values.each do |cfg|
  help_file << "#define #{cfg[:key].upcase}_HELP _HELPSTR(\"#{cfg[:note]}\")\n"
end

help_file << <<-CC

#ifdef __cplusplus
}
#endif

#endif
CC

help_file_path = File.join(DIR, "include", "assets", "config_help.h");
current_help = File.read(help_file_path)

if help_file != current_help
  if opts[:fix]
    File.write(help_file_path, help_file)
  else
    puts "Help file mismatch, please run with --fix"
  end

  error help_file_path, 0, "Help file mismatch.", opts[:fix]
end

###

puts
# error count
if $errors.length > 0
  $errors.each do |err|
    puts "IN #{err[:file]}:#{err[:line] || 0}\n  > #{err[:message]}"
  end
  puts
  puts "#{$errors.length} errors!"
  exit 1
else
  puts "No errors!"
end
